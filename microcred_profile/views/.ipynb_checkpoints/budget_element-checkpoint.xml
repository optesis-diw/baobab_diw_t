<?xml version="1.0" encoding="UTF-8"?>
<odoo>

        ##############################################################################
        #
        #    microcred_profile module for odoo, Profile for Microcred
        #    Copyright (C) 2016 SYLEAM Info Services ([http://www.Syleam.fr/])
        #              Yannis Pou-Vich [yannis.pouvich@syleam.fr]
        #              Chris TRIBBECK [chris.tribbeck@syleam.fr]
        #
        #    This file is a part of microcred_profile
        #
        #    microcred_profile is free software: you can redistribute it and/or modify
        #    it under the terms of the GNU Affero General Public License as published by
        #    the Free Software Foundation, either version 3 of the License, or
        #    (at your option) any later version.
        #
        #    microcred_profile is distributed in the hope that it will be useful,
        #    but WITHOUT ANY WARRANTY; without even the implied warranty of
        #    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
        #    GNU Affero General Public License for more details.
        #
        #    You should have received a copy of the GNU Affero General Public License
        #    along with this program.  If not, see [http://www.gnu.org/licenses/].
        #
        ##############################################################################

            <record id="budget_element_microcred_search" model="ir.ui.view">
            <field name="name">budget.element.microcred.search</field>
            <field name="model">budget.element</field>
            <field name="inherit_id" ref="advanced_budget.view_budget_element_search"/>
            <field name="priority" eval="90"/>
            <field name="arch" type="xml">
                <xpath expr="//group" position="inside">
                    <filter name="grp_budget_department" string="Budget department" domain="[]" context="{'group_by':'budget_department_id'}"/>
                </xpath>
                <xpath expr="//field[@name='partner_id']" position="after">
                    <field name="all_tag_ids"/>
                </xpath>
                <xpath expr="//group" position="before">
                    <field name="child_tag_ids"/>
                    <separator/>
                    <filter string="My department's" domain="['|', ('user_id', '=', uid), ('budget_department_id.user_id', '=', uid)]" name="departments" groups="microcred_profile.group_microcred_department_manager"/>
                </xpath>
            </field>
        </record>

        <record id="budget_element_microcred_tree" model="ir.ui.view">
            <field name="name">budget.element.microcred.tree</field>
            <field name="model">budget.element</field>
            <field name="inherit_id" ref="advanced_budget.view_budget_element_tree"/>
            <field name="priority" eval="90"/>
            <field name="arch" type="xml">
                <xpath expr="//field[@name='amount_calculated']" position="replace">
                    <field name="amount_fixed" string="Amount planned"/>
                </xpath>
                <xpath expr="//field[@name='amount_invoiced']" position="after">
                    <field name="currency_id"/>
                </xpath>
                
                <xpath expr="//field[@name='amount_invoiced']" position="before">
                    <field name="amount_engaged" sum="Total" widget="monetary" options="{'currency_field': 'currency_id'}"/>
                </xpath>
                <xpath expr="//field[@name='amount_invoiced']" position="after">
                    <field name="amount_remaining" sum="Total" widget="monetary" options="{'currency_field': 'currency_id'}"/>
                </xpath>
                <xpath expr="//field[@name='amount_fixed']" position="attributes">
                    <attribute name="sum">Total</attribute>
                    <attribute name="widget">monetary</attribute>
                    <attribute name="options">{'currency_field': 'currency_id'}</attribute>
                </xpath>
                <xpath expr="//field[@name='amount_invoiced']" position="attributes">
                    <attribute name="sum">Total</attribute>
                    <attribute name="widget">monetary</attribute>
                    <attribute name="options">{'currency_field': 'currency_id'}</attribute>
                </xpath>
            </field>
        </record>

        <record model="ir.actions.act_window.view" id="advanced_budget.act_open_budget_element_view_tree">
            <field name="act_window_id" ref="advanced_budget.action_budget_element"/>
            <field name="sequence" eval="10"/>
             <field name="view_mode">tree</field>
            <field name="view_id" ref="budget_element_microcred_tree"/>
        </record>   
        <record id="advanced_budget.action_budget_element" model="ir.actions.act_window">
            <field name="name">Budgets</field>
            <field name="type">ir.actions.act_window</field>
            <field name="res_model">budget.element</field>
            <field name="view_mode">tree,form</field>
             <field name="view_mode">form</field>
            <field name="context">{}</field>
            <field name="domain">[('type', 'in', ('periodic', 'project')), ('user_can_modify', '=', True)]</field>
            <field name="search_view_id" ref="budget_element_microcred_search"/>
            <field name="help" type="html">
                <p class="oe_view_nocontent_create">
                    Click to define a new budget element.
                    </p><p>
                    You must define budget elements in order to manage your budgets.
                </p>
            </field>
        </record>

      <record model="ir.ui.view" id="budget_element_microcred_line_form">
            <field name="name">budget.element.form</field>
            <field name="model">budget.element</field>
            <field name="priority" eval="4"/>
            <field name="arch" type="xml">
                <form>
                    <div class="oe_button_box" name="button_box">
                        <button name="list_purchases" type="object" class="oe_stat_button" icon="fa-truck"
                                groups="microcred_profile.group_microcred_accountant,microcred_profile.group_microcred_admin,microcred_profile.group_microcred_department_manager">
                            <field name="purchase_count" widget="statinfo" string="Purchases"
                                help="The number of purchase orders linked to this budget element, and its children."/>
                        </button>
                        <button name="list_invoices" type="object" class="oe_stat_button" icon="fa-briefcase">
                            <field name="invoice_count" widget="statinfo" string="Invoices"
                                help="The number of invoices linked to this budget element, and its children."/>
                        </button>
                        <button name="list_account_moves" type="object" class="oe_stat_button" icon="fa-book"
                            groups="microcred_profile.group_microcred_accountant,microcred_profile.group_microcred_admin">
                            <field name="account_move_count" widget="statinfo" string="Account lines"
                                help="The number of account lines linked to this budget element, and its children."/>
                        </button>
                    </div> 
                    <group colspan="4" col="4">
                        <group colspan="2">
                            <separator string="Budget line information" colspan="2"/>
                            <field name="budget_line_type_id" options="{'no_create': True, 'no_open': True}" attrs="{'readonly': ['|', ('state', 'not in', ['draft']), ('is_readonly', '=', True)]}"/>
                            <field name="name" attrs="{'readonly': ['|', ('state', 'not in', ['draft']), ('is_readonly', '=', True)]}"/>
                            <field name="subtype_id" widget="selection" attrs="{'readonly': ['|', ('state', 'not in', ['draft']), ('is_readonly', '=', True)]}"/>
                            <field name="budget_id" options="{'no_create': True, 'no_open': True}" attrs="{'readonly': ['|', ('state', 'not in', ['draft']), ('is_readonly', '=', True)]}"/>
                            <field name="user_id" attrs="{'readonly': ['|', ('state', 'not in', ['draft']), ('is_readonly', '=', True)]}"/>
                            <field name="user_can_modify" invisible="1" />
                            <field name="type_id" invisible="1" />
                            <field name="is_readonly" invisible="1" />
                            <field name="has_details" invisible="1" />
                            <field name="has_manual_periods" invisible="1" />
                            <field name="state" invisible="1" />
                            <field name="subtype" invisible="1" />
                            <field name="currency_id" invisible="1" />
                        </group>
                        <group colspan="2">
                            <separator string="Tags and Axes" colspan="2"/>
                            <label for="all_tag_ids"/>
                            <div>
                                <field name="all_tag_ids" readonly="1" widget="many2many_tags" nolabel="1" class="oe_inline"/>
                                <button string="Set axes" icon="fa-map-o" type="action" name="%(action_wizard_change_account_tags)d"
                                    attrs="{'invisible': [('user_can_modify','=', False)]}" class="oe_inline oe_link"/>
                            </div>
                        </group>
                        <notebook colspan="4">
                            <page string="Amounts" col="4">
                                <group col="2">
                                    <group>
                                        <label for="amount_fixed" string="Forecast"/>
                                        <div>
                                            <field name="amount_fixed" class="oe_inline" attrs="{'readonly': ['|', ('state', 'not in', ['draft']), ('is_readonly', '=', True)]}"
                                                help="Total amount of your budget." widget="monetary"/>
                                            <button string="" icon="fa-pencil" type="action" name="%(advanced_budget.action_wizard_modify_amount)d"
                                                attrs="{'invisible': ['|', ('is_readonly', '=', True), ('state', 'in', ('draft', 'cancel', 'done'))]}"
                                                class="oe_link" groups="microcred_profile.group_microcred_admin,microcred_profile.group_microcred_cost_control"/>
                                            <button string="Transfer" icon="fa-briefcase" type="action" name="%(action_wizard_transfer_budget_amount)d"
                                                class="oe_link" attrs="{'invisible': ['|', ('linked_distribution_id', '!=', False), '|', ('state', 'in', ('cancel', 'done')), ('budget_detail_ids', '!=', [])]}" />
                                        </div>
                                        <field name="amount_engaged" widget="monetary"/>
                                        <field name="amount_invoiced" widget="monetary"/>
                                        <field name="amount_remaining" widget="monetary"/>
                                    </group>
                                    <group>
                                        <field name="profit_loss_amount_fixed" string="P&amp;L Forecast" widget="monetary"/>
                                        <field name="profit_loss_amount_engaged" widget="monetary"/>
                                        <field name="profit_loss_amount_invoiced" widget="monetary"/>
                                        <field name="profit_loss_amount_remaining" widget="monetary"/>
                                    </group>
                                </group>
                                <field name="currency_id" invisible="1" />
                                <field name="company_id" invisible="1" />
                                <field name="linked_distribution_id" invisible="1" />
                            </page>
                            <page string="Monthly amounts">
                                <field name="period_detail_ids" nolabel="1" attrs="{'readonly': ['|', ('budget_detail_ids', '!=', []), ('is_readonly', '=', True)]}">
                                    <tree string="Period details" editable="top" create="false" delete="false" default_order="period_id desc">
                                        <field name="period_id"/>
                                        <field name="amount_fixed" widget="monetary" sum="Amount fixed"/>
                                        <field name="amount_engaged" widget="monetary" sum="Amount engaged"/>
                                        <field name="amount_invoiced" widget="monetary" sum="Amount invoiced"/>
                                        <field name="profit_loss_amount_fixed" widget="monetary" sum="P&amp;L amount fixed"/>
                                        <field name="profit_loss_amount_engaged" widget="monetary" sum="P&amp;L amount engaged"/>
                                        <field name="profit_loss_amount_invoiced" widget="monetary" sum="P&amp;L amount invoiced"/>
                                        <field name="currency_id" invisible="1" />
                                    </tree>
                                </field>
                                <div attrs="{'invisible': [('error_text','=', False)]}" style="background-color: #FF4040; color: #800000; text-align: center;">
                                    <strong><field name="error_text"/></strong>
                                </div>
                            </page>
                            <page string="Details" attrs="{'invisible': [('subtype','=', 'amortised')]}">
                                <group colspan="4">
                                    <field name="budget_detail_ids" nolabel="1" colspan="2" attrs="{'readonly': [('state', 'not in', ['draft'])]}"
                                        context="{'default_type_id': %(advanced_budget.budget_element_type_detail)d, 'default_company_id': company_id}">
                                        <tree string="Budget Details" decoration-muted="is_readonly == True" decoration-danger="error_text != False">
                                            <field name="sequence" invisible="1"/>
                                            <field name="budget_line_type_id" options="{'no_create': True, 'no_open': True}"/>
                                            <field name="name" attrs="{'readonly': [('budget_line_type_id', '!=', False)]}"/>
                                            <field name="all_tag_ids" readonly="1" widget="many2many_tags"/>
                                            <field name="amount_fixed" sum="Amount planned" string="Forecast" widget="monetary"/>
                                            <field name="amount_engaged" sum="Amount engaged" widget="monetary" />
                                            <field name="amount_invoiced" sum="Amount engaged" widget="monetary" />
                                            <field name="profit_loss_amount_fixed" sum="Amount planned" string="P&amp;L Forecast" widget="monetary"/>
                                            <field name="profit_loss_amount_invoiced" sum="Amount engaged" widget="monetary" />
                                            <field name="text_distribution"/>
                                            <button string="Create purchase" icon="fa-cart-plus" type="object"
                                                name="create_purchase"/>
                                            <button string="Create supplier invoice" icon="fa-money" type="object"
                                                name="create_invoice"/>
                                            <field name="is_readonly" invisible="1" />
                                            <field name="type_id" invisible="1" />
                                            <field name="state" invisible="1" />
                                            <field name="has_manual_periods" invisible="1" />
                                            <field name="date_planned" invisible="1" />
                                            <field name="user_can_modify" invisible="1" />
                                            <field name="currency_id" invisible="1" />
                                            <field name="error_text" invisible="1" />
                                        </tree>
                                        <form>
                                            <group colspan="4" col="4">
                                                <group colspan="2">
                                                    <separator string="Budget line information" colspan="2"/>
                                                    <field name="budget_line_type_id" options="{'no_create': True, 'no_open': True}" widget="selction"/>
                                                    <field name="name"/>
                                                    <field name="subtype_id" attrs="{'readonly': [('is_readonly', '=', True)]}" widget="selection"/>
                                                    <field name="user_can_modify" invisible="1" />
                                                    <field name="type_id" invisible="1" />
                                                    <field name="is_readonly" invisible="1" />
                                                    <field name="has_details" invisible="1" />
                                                    <field name="has_manual_periods" invisible="1" />
                                                    <field name="state" invisible="1" />
                                                    <field name="subtype" invisible="1" />
                                                    <field name="currency_id" invisible="1" />
                                                </group>
                                                <group colspan="2">
                                                    <separator string="Tags and Axes" colspan="2"/>
                                                    <label for="all_tag_ids"/>
                                                    <div>
                                                        <field name="all_tag_ids" readonly="1" widget="many2many_tags" nolabel="1" class="oe_inline"/>
                                                        <button string="Set axes" icon="fa-map-o" type="action" name="%(action_wizard_change_account_tags)d"
                                                            attrs="{'invisible': [('user_can_modify','=', False)]}" class="oe_inline oe_link"/>
                                                    </div>
                                                </group>
                                                <notebook colspan="4">
                                                    <page string="Amounts" col="4">
                                                        <group col="2">
                                                            <group>
                                                                <label for="amount_fixed"/>
                                                                <div>
                                                                    <field name="amount_fixed" class="oe_inline" help="Total amount of your budget." widget="monetary"
                                                                        attrs="{'readonly': ['|', '|', ('state', 'not in', ['draft']), ('is_readonly', '=', True), ('has_details', '=', True)]}"/>
                                                                    <button string="Transfer" icon="fa-briefcase" type="action" name="%(action_wizard_transfer_budget_amount)d"
                                                                        class="oe_link" attrs="{'invisible': ['|', ('linked_distribution_id', '!=', False), '|', ('state', 'in', ('cancel', 'done')), ('budget_detail_ids', '!=', [])]}" />
                                                                </div>
                                                                <label for="amount_engaged"/>
                                                                <div>
                                                                    <field name="amount_engaged" widget="monetary" attrs="{'readonly': [('has_details','=', True)]}"/>
                                                                    <button string="Purchase lines" icon="fa-arrow-right" type="action" name="%(action_wizard_view_budget_purchase_data)d"
                                                                        class="oe_link" attrs="{'invisible': [('linked_distribution_id', '!=', False)]}" />
                                                                </div>
                                                                <label for="amount_invoiced"/>
                                                                <div>
                                                                    <field name="amount_invoiced" widget="monetary"/>
                                                                    <button string="Journal entries" icon="fa-arrow-right" type="action" name="%(action_wizard_view_budget_journal_data)d"
                                                                        class="oe_link" attrs="{'invisible': [('linked_distribution_id', '!=', False)]}" />
                                                                </div>
                                                                <field name="amount_remaining" widget="monetary"/>
                                                            </group>
                                                            <group>
                                                                <field name="profit_loss_amount_fixed" string="P&amp;L Forecast" widget="monetary"/>
                                                                <label for="profit_loss_amount_engaged"/>
                                                                <div>
                                                                    <field name="profit_loss_amount_engaged" widget="monetary"/>
                                                                  
                                                                </div>
                                                                <field name="profit_loss_amount_invoiced" widget="monetary"/>
                                                                <field name="profit_loss_amount_remaining" widget="monetary"/>
                                                            </group>
                                                            <field name="linked_distribution_id" invisible="1" />
                                                            <field name="budget_detail_ids" invisible="1" />
                                                        </group>
                                                    </page>
                                                    <page string="Monthly amounts">
                                                        <field name="period_detail_ids" nolabel="1" attrs="{'readonly': ['|', ('budget_detail_ids', '!=', []), ('is_readonly', '=', True)]}">
                                                            <tree string="Period details" editable="top" create="false" delete="false" default_order="period_id desc">
                                                                <field name="period_id"/>
                                                                <field name="amount_fixed" widget="monetary" sum="Amount fixed"/>
                                                                <field name="amount_engaged" widget="monetary" sum="Amount engaged"/>
                                                                <field name="amount_invoiced" widget="monetary" sum="Amount invoiced"/>
                                                                <field name="profit_loss_amount_fixed" widget="monetary" sum="P&amp;L amount fixed"/>
                                                                <field name="profit_loss_amount_engaged" widget="monetary" sum="P&amp;L amount engaged"/>
                                                                <field name="profit_loss_amount_invoiced" widget="monetary" sum="P&amp;L amount invoiced"/>
                                                                <field name="currency_id" invisible="1"/>
                                                            </tree>
                                                        </field>
                                                        <div attrs="{'invisible': [('error_text','=', False)]}" style="background-color: #FF4040; color: #800000; text-align: center;">
                                                            <strong><field name="error_text"/></strong>
                                                        </div>
                                                    </page>
                                                 
                                                    <page string="Cost distribution" name="line_costs">
                                                        <div>
                                                            Use this tab to define to which departments and/or partners your costs are to be affected (unless specified per line / detail).
                                                        </div>
                                                        <field name="distribution_cost_ids">
                                                            <button string="Specific distribution" icon="fa-tasks" type="action"
                                                                name="%(advanced_budget.action_wizard_add_budget_distribution)d"
                                                                attrs="{'invisible': [('state','in', ('draft', 'cancel', 'done'))]}"/>
                                                            <tree editable="bottom">
                                                                <field name="child_id" domain="[('type', '=', 'partner')]"
                                                                    options="{'no_create': True}" string="Partner" required="1" />
                                                                <field name="amount_fixed" widget="monetary"/>
                                                                <field name="percentage" sum="percentage"/>
                                                                <field name="amount_calculated" sum="Amount planned" widget="monetary"/>
                                                                <field name="currency_id" invisible="1" />
                                                            </tree>
                                                        </field>
                                                    </page>
                                                    <page string="Budget distribution" name="budgets">
                                                        <div>
                                                            Use this tab to define to which budgets your costs are to be affected (if any). IF YOU ADD A BUDGETARY DISTRIBUTION HERE, DO NOT ADD ANY TO THIS DETAIL'S LINE OR THE LINE'S PARENT BUDGET.
                                                        </div>
                                                        <field name="distribution_budget_ids" attrs="{'readonly': [('state', 'not in', ['draft'])]}">
                                                            <tree editable="bottom">
                                                                <field name="child_id" domain="[('type', 'in', ('periodic', 'project'))]"
                                                                    options="{'no_create': True}" string="Budget" required="1" />
                                                                <field name="amount_fixed" widget="monetary"/>
                                                                <field name="percentage" sum="percentage"/>
                                                                <field name="amount_calculated" sum="Amount planned" widget="monetary"/>
                                                                <field name="currency_id" invisible="1" />
                                                            </tree>
                                                        </field>
                                                    </page>
                                                </notebook>
                                            </group>
                                        </form>
                                    </field>
                                </group>
                            </page>
                          
                            <page string="Cost distribution" name="line_costs">
                                <div>
                                    Use this tab to define to which departments and/or partners your costs are to be affected (unless specified per line / detail).
                                </div>
                                <field name="distribution_cost_ids">
                                    <tree editable="bottom">
                                        <field name="child_id" domain="[('type', '=', 'partner')]"
                                            options="{'no_create': True}" string="Partner" required="1" />
                                        <field name="amount_fixed" widget="monetary"/>
                                        <field name="percentage" sum="Percentage"/>
                                        <field name="amount_calculated" sum="Amount planned" widget="monetary"/>
                                        <field name="currency_id" invisible="1" />
                                    </tree>
                                </field>
                            </page>
                            <page string="Budget distribution" name="budgets">
                                <div>
                                    Use this tab to define to which budgets your costs are to be affected (if any). IF YOU ADD A BUDGETARY DISTRIBUTION HERE, DO NOT ADD ANY TO THIS LINE'S PARENT BUDGET.
                                </div>
                                <field name="distribution_budget_ids" attrs="{'readonly': [('state', 'not in', ['draft'])]}">
                                    <tree editable="bottom">
                                        <field name="child_id" domain="[('type', 'in', ('periodic', 'project'))]"
                                            options="{'no_create': True}" string="Budget" required="1" />
                                        <field name="amount_fixed" widget="monetary"/>
                                        <field name="percentage" sum="Percentage"/>
                                        <field name="amount_calculated" sum="Amount planned" widget="monetary"/>
                                        <field name="currency_id" invisible="1" />
                                    </tree>
                                </field>
                            </page>
                        </notebook>
                    </group>
                    <div class="oe_chatter">
                        <field name="message_follower_ids" widget="mail_followers"
                            attrs="{'invisible': [('user_can_modify', '=', False)]}"/>
                        <field name="message_ids" widget="mail_thread"/>
                    </div>
                             
                </form> 
            </field>
        </record> 

       <record model="ir.ui.view" id="budget_element_microcred_line_editable_form">
            <field name="name">budget.element.form</field>
            <field name="model">budget.element</field>
               <field name="groups_id" eval="[(4, ref('microcred_profile.group_microcred_admin')), (4, ref('microcred_profile.group_microcred_cost_control'))]"/>  
            <field name="inherit_id" ref="budget_element_microcred_line_form"/>
            <field name="priority" eval="91"/>
            <field name="arch" type="xml">
                <xpath expr="//field[@name='budget_detail_ids']" position="attributes">
                    <attribute name="attrs">{'readonly': [('state', 'in', ['cancel', 'done'])]}</attribute>
                </xpath>
                <xpath expr="//field[@name='user_id']" position="attributes">
                    <attribute name="attrs">{'readonly': [('state', 'in', ['cancel', 'done'])]}</attribute>
                </xpath>
                <xpath expr="//field[@name='budget_detail_ids']" position="attributes">
                    <attribute name="attrs">{'readonly': [('state', 'in', ['cancel', 'done'])]}</attribute>
                </xpath>
                
               
                <xpath expr="//field[@name='distribution_budget_ids']" position="attributes">
                    <attribute name="attrs">{'readonly': [('state', 'in', ['cancel', 'done'])]}</attribute>
                </xpath>
            </field>
        </record>
       

            <record model="ir.ui.view" id="budget_element_microcred_form">
            <field name="name">budget.element.form</field>
            <field name="model">budget.element</field>
            <field name="inherit_id" ref="advanced_budget.view_budget_element_form"/>
            <field name="priority" eval="90"/>
            <field name="arch" type="xml">
                <xpath expr="//form" position="replace">
                    <form string="Budget element" colspan="4" col="4">
                        <div class="oe_button_box" name="button_box">
                            <button name="list_purchases" type="object" class="oe_stat_button" icon="fa-truck">
                                <field name="purchase_count" widget="statinfo" string="Purchases"
                                    help="The number of purchase orders linked to this budget element, and its children."/>
                            </button>
                            <button name="list_invoices" type="object" class="oe_stat_button" icon="fa-briefcase">
                                <field name="invoice_count" widget="statinfo" string="Invoices"
                                    help="The number of invoices linked to this budget element, and its children."/>
                            </button>
                             <button name="list_account_moves" type="object" class="oe_stat_button" icon="fa-book"
                                groups="microcred_profile.group_microcred_accountant,microcred_profile.group_microcred_admin">
                                <field name="account_move_count" widget="statinfo" string="Account lines"
                                    help="The number of account lines linked to this budget element, and its children."/>
                            </button> 
                        </div>
                        <header attrs="{'invisible': [('type','not in', ('periodic', 'project'))]}">
                            <button string="Proposition" states="draft" class="oe_highlight" type="object" name="action_propose_budget"
                                attrs="{'invisible': ['|', ('user_can_modify', '=', False), ('state', '!=', 'draft')]}"/>
                            <button string="Return to draft" states="proposition" type="object" name="action_redraft_budget"
                                groups="microcred_profile.group_microcred_admin,microcred_profile.group_microcred_cost_control"/>
                            <button string="Open" states="proposition" class="oe_highlight" type="object" name="action_open_budget"
                                groups="microcred_profile.group_microcred_admin,microcred_profile.group_microcred_cost_control"/>
                            <button string="Close" states="open" class="oe_highlight" type="object" name="action_close_budget"
                                groups="microcred_profile.group_microcred_admin,microcred_profile.group_microcred_cost_control"/>
                            <button string="Cancel" states="draft,open" type="object" name="action_cancel_budget"
                                groups="microcred_profile.group_microcred_admin,microcred_profile.group_microcred_cost_control"/>
                            <button string="Uncancel" states="cancel" type="object" name="action_uncancel_budget"
                                groups="microcred_profile.group_microcred_admin,microcred_profile.group_microcred_cost_control"/>
                            <button string="Return to draft" states="cancel,close,done" type="object" name="action_redraft_budget"
                                groups="microcred_profile.group_microcred_admin,microcred_profile.group_microcred_cost_control"/>
                            <field name="state" widget="statusbar" nolabel="1" statusbar_visible="draft,proposition,open,done"/>
                        </header> 
                        <group colspan="4">
                            <label for="name" string="Name" class="oe_edit_only"/><newline/>
                            <div class="oe_title oe_left" style="width: 72%;" colspan="2">
                                <h1>
                                    <field name="name" placeholder="Budget element's name" attrs="{'readonly': [('state', 'not in', ['draft'])]}"/>
                                </h1>
                            </div>
                            <group colspan="4" col="6" name="main_group">
                                <group colspan="2" col="2">
                                    <field name="code" placeholder="Budget element's code" attrs="{'readonly': [('state', 'not in', ['draft'])]}" invisible="1" />
                                    <field name="user_id" placeholder="The budget's manager" attrs="{'readonly': [('state', 'not in', ['draft'])]}"/>
                                    <field name="budget_department_id" attrs="{'invisible': [('type','not in', ('periodic', 'project'))], 'readonly': [('state', 'not in', 'draft')]}"
                                        domain="[('type', '=', 'department')]"/>
                                </group>
                                <group colspan="2" col="2">
                                    <field name="type_id" attrs="{'readonly': [('state', 'not in', ['draft'])]}" widget="selection"
                                        domain="[('type', 'in', ('periodic', 'project', 'department', 'partner'))]" />
                                    <label for="date_start" string="Period" attrs="{'invisible': [('type', 'not in', ('periodic', 'project'))]}"/>
                                    <div attrs="{'invisible': [('type', 'not in', ('periodic', 'project'))]}" name="date_div">
                                        <field name="date_start" nolabel="1" class="oe_inline"
                                            attrs="{'required': [('type', '=', 'periodic')], 'readonly': [('state', 'not in', ('draft'))]}"/> to
                                        <field name="date_end" nolabel="1" class="oe_inline"
                                            attrs="{'required': [('type', 'in', ('periodic', 'project'))], 'readonly': [('state', 'not in', ('draft'))]}"/>
                                    </div>
                                    <field name="project_id" attrs="{'readonly': [('state', 'not in', ('draft'))], 'invisible': [('type', '!=', 'project')], 'required': [('type', '=', 'project')]}"/>
                                    <field name="department_id" attrs="{'readonly': [('state', 'not in', ('draft'))], 'invisible': [('type', '!=', 'department')], 'required': [('type', '=', 'department')]}"/>
                                    <field name="partner_id" attrs="{'readonly': [('state', 'not in', ('draft'))], 'invisible': [('type', '!=', 'partner')], 'required': [('type', '=', 'partner')]}"/>
                                    <field name="expensify_code" attrs="{'invisible': [('type', '!=', 'partner')], 'required': [('type', '=', 'partner')]}"/>
                                    <field name="reinvoiceable" attrs="{'invisible': [('type', '!=', 'partner')]}"/>
                                    <field name="product_id" attrs="{'readonly': [('state', 'not in', ('draft'))], 'invisible': [('type', '!=', 'budget_detail')]}"/>
                                    <field name="type" invisible="1" />
                                    <field name="company_id" options="{'no_create': True}" groups="base.group_multi_company"
                                        attrs="{'required': [('type', '!=', 'partner')], 'readonly': [('state', '!=', 'draft')]}"/>
                                </group>
                                <group colspan="2">
                                    <label for="all_tag_ids"/>
                                    <div>
                                        <field name="all_tag_ids" readonly="1" class="oe_inline" widget="many2many_tags"/>
                                        <button string="Set axes" icon="fa-map-o" type="action" name="%(action_wizard_change_account_tags)d"
                                            class="oe_inline oe_link" attrs="{'invisible': [('user_can_modify','=', False)]}"/>
                                    </div>
                                </group>
                                <field name="user_can_modify" invisible="1" />
                                <field name="currency_id" invisible="1" />
                                <field name="is_readonly" invisible="1" />
                            </group>
                            <group colspan="4" attrs="{'invisible': [('user_can_modify', '=', False)]}">
                                <separator string="Budget information" colspan="4"/>
                                <group colspan="4" attrs="{'invisible': [('type', 'not in', ('periodic', 'project'))]}" col="4">
                                    <group colspan="2">
                                        <label for="amount_fixed" string="Authorised budget"/>
                                        <div>
                                            <field name="amount_fixed" class="oe_inline" attrs="{'readonly': ['|', ('state', 'not in', ['draft']), ('is_readonly', '=', True)]}"
                                                help="Total amount of your budget." widget="monetary"/>
                                            <button string="" icon="fa-pencil" type="action" name="%(advanced_budget.action_wizard_modify_amount)d"
                                                attrs="{'invisible': ['|', ('is_readonly', '=', True), ('state', 'in', ('draft', 'cancel', 'done'))]}"
                                                class="oe_link" groups="microcred_profile.group_microcred_admin,microcred_profile.group_microcred_cost_control"/>
                                        </div>
                                        <field name="amount_calculated" string="Calculated"
                                            help="Sum of Calculated budget lines. In case the Calculated is below the authorised budget, some budgets have not been attributed to any budget line and remaining amounts can be added to any budget line." widget="monetary"/>
                                    </group>
                                    <group colspan="2">
                                        <field name="amount_engaged" attrs="{'invisible': [('was_opened','=', False)]}" help="Sum of the opened purchase orders engaged but not yet invoiced on this budget." widget="monetary"/>
                                        <field name="amount_invoiced" attrs="{'invisible': [('was_opened','=', False)]}" help="Sum of the accounted invoices on this budget." widget="monetary"/>
                                        <field name="amount_remaining" attrs="{'invisible': [('was_opened','=', False)]}" widget="monetary"/>
                                    </group>
                                    <field name="was_opened" invisible="1" />
                                    <field name="linked_distribution_id" invisible="1" />
                                </group>
                                <notebook colspan="4">
                                    <page string="Budget lines" name="lines"
                                        attrs="{'invisible': [('type', 'not in', ('periodic', 'project'))]}">
                                        <div>
                                            Use this tab to define budget lines for this budget. Extra costs may be added from other budgets - these appear in the "Sub-budgets" tab.
                                        </div>
                                        <field name="budget_line_ids" attrs="{'readonly': [('state', 'not in', ['draft'])]}"
                                            context="{'default_type_id': %(advanced_budget.budget_element_type_line)d, 'default_user_can_modify': True, 'default_company_id': company_id}">
                                            <tree string="Budget lines" decoration-muted="is_readonly == True" decoration-danger="error_text != False">
                                                <field name="sequence" invisible="1"/>
                                                <field name="name"/>
                                                <field name="all_tag_ids" readonly="1" widget="many2many_tags"/>
                                                <field name="user_can_modify" invisible="1" />
                                                <field name="amount_fixed" sum="Amount planned" string="Calculated" widget="monetary"/>
                                                <field name="has_manual_periods" invisible="1" />
                                                <button string="Modify" icon="fa-pencil" type="action" name="%(advanced_budget.action_wizard_modify_amount)d"
                                                    attrs="{'invisible': ['|', ('is_readonly', '=', True), ('state', 'in', ('draft', 'cancel', 'done'))]}"
                                                    groups="microcred_profile.group_microcred_admin,microcred_profile.group_microcred_cost_control"/> 
                                                <field name="amount_engaged" sum="Amount engaged"  widget="monetary"/>
                                                <field name="amount_invoiced" sum="Amount engaged"  widget="monetary"/>
                                                <field name="amount_remaining" sum="Amount engaged"  widget="monetary"/>
                                                <field name="profit_loss_amount_fixed" sum="P&amp;L Calculated" string="P&amp;L Calculated" widget="monetary"/>
                                                <field name="profit_loss_amount_invoiced" sum="P&amp;L Invoiced" widget="monetary"/>
                                                <field name="text_distribution"/>
                                                <field name="type_id" invisible="1" />
                                                <field name="is_readonly" invisible="1" />
                                                <field name="has_details" invisible="1" />
                                                <field name="state" invisible="1" />
                                                <field name="subtype" invisible="1" />
                                                <field name="currency_id" invisible="1" />
                                                <field name="error_text" invisible="1" />
                                            </tree>
                                            <form>
                                                <group colspan="4" col="4">
                                                    <group colspan="2">
                                                        <separator string="Budget line information" colspan="2"/>
                                                        <field name="budget_line_type_id" options="{'no_create': True, 'no_open': True}" widget="selction"/>
                                                        <field name="name"/>
                                                        <field name="subtype_id" attrs="{'readonly': [('is_readonly', '=', True)]}" widget="selection"/>
                                                        <field name="user_can_modify" invisible="1" />
                                                        <field name="type_id" invisible="1" />
                                                        <field name="is_readonly" invisible="1" />
                                                        <field name="has_details" invisible="1" />
                                                        <field name="has_manual_periods" invisible="1" />
                                                        <field name="state" invisible="1" />
                                                        <field name="subtype" invisible="1" />
                                                        <field name="currency_id" invisible="1" />
                                                    </group>
                                                    <group colspan="2">
                                                        <separator string="Tags and Axes" colspan="2"/>
                                                        <label for="all_tag_ids"/>
                                                        <div>
                                                            <field name="all_tag_ids" readonly="1" widget="many2many_tags" nolabel="1" class="oe_inline"/>
                                                            <button string="Set axes" icon="fa-map-o" type="action" name="%(action_wizard_change_account_tags)d"
                                                                attrs="{'invisible': [('user_can_modify','=', False)]}" class="oe_inline oe_link"/>
                                                        </div>
                                                    </group>
                                                    <notebook colspan="4">
                                                        <page string="Amounts" col="4">
                                                            <group col="2">
                                                                <group>
                                                                    <label for="amount_fixed"/>
                                                                    <div>
                                                                        <field name="amount_fixed" class="oe_inline" help="Total amount of your budget." widget="monetary"
                                                                            attrs="{'readonly': ['|', '|', ('state', 'not in', ['draft']), ('is_readonly', '=', True), ('has_details', '=', True)]}"/>
                                                                        <button string="Transfer" icon="fa-briefcase" type="action" name="%(action_wizard_transfer_budget_amount)d"
                                                                            class="oe_link" attrs="{'invisible': ['|', ('linked_distribution_id', '!=', False), '|', ('state', 'in', ('cancel', 'done')), ('budget_detail_ids', '!=', [])]}" />
                                                                    </div>
                                                                    <label for="amount_engaged"/>
                                                                    <div>
                                                                        <field name="amount_engaged" widget="monetary" />
                                                                        <button string="Purchase lines" icon="fa-arrow-right" type="action" name="%(action_wizard_view_budget_purchase_data)d"
                                                                            class="oe_link" attrs="{'invisible': [('linked_distribution_id', '!=', False)]}" />
                                                                    </div>
                                                                    <label for="amount_invoiced"/>
                                                                    <div>
                                                                        <field name="amount_invoiced" widget="monetary"/>
                                                                        <button string="Journal entries" icon="fa-arrow-right" type="action" name="%(action_wizard_view_budget_journal_data)d"
                                                                            class="oe_link" attrs="{'invisible': [('linked_distribution_id', '!=', False)]}" />
                                                                    </div>
                                                                    <field name="amount_remaining" widget="monetary"/>
                                                                </group>
                                                                <group>
                                                                    <field name="profit_loss_amount_fixed" string="P&amp;L Forecast" widget="monetary"/>
                                                                    <label for="profit_loss_amount_engaged"/>
                                                                    <div>
                                                                        <field name="profit_loss_amount_engaged" widget="monetary"/>
                                                                       
                                                                    </div>
                                                                    <field name="profit_loss_amount_invoiced" widget="monetary"/>
                                                                    <field name="profit_loss_amount_remaining" widget="monetary"/>
                                                                </group>
                                                                <field name="linked_distribution_id" invisible="1" />
                                                            </group>
                                                            <field name="currency_id" invisible="1" />
                                                            <field name="company_id" invisible="1" />
                                                        </page>
                                                        <page string="Monthly amounts">
                                                            <field name="period_detail_ids" nolabel="1" attrs="{'readonly': ['|', ('budget_detail_ids', '!=', []), ('is_readonly', '=', True)]}">
                                                                <tree string="Period details" editable="top" create="false" delete="false" default_order="period_id desc">
                                                                    <field name="period_id"/>
                                                                    <field name="amount_fixed" widget="monetary" sum="Amount fixed"/>
                                                                    <field name="amount_engaged" widget="monetary" sum="Amount engaged"/>
                                                                    <field name="amount_invoiced" widget="monetary" sum="Amount invoiced"/>
                                                                    <field name="profit_loss_amount_fixed" widget="monetary" sum="P&amp;L amount fixed"/>
                                                                    <field name="profit_loss_amount_engaged" widget="monetary" sum="P&amp;L amount engaged"/>
                                                                    <field name="profit_loss_amount_invoiced" widget="monetary" sum="P&amp;L amount invoiced"/>
                                                                    <field name="currency_id" invisible="1" />
                                                                </tree>
                                                            </field>
                                                            <div attrs="{'invisible': [('error_text','=', False)]}" style="background-color: #FF4040; color: #800000; text-align: center;">
                                                                <strong><field name="error_text"/></strong>
                                                            </div>
                                                        </page>
                                                        <page string="Details" attrs="{'invisible': [('subtype','=', 'amortised')]}">
                                                            <group colspan="4">
                                                                <field name="budget_detail_ids" nolabel="1" colspan="2"
                                                                    context="{'default_type_id': %(advanced_budget.budget_element_type_detail)d, 'default_user_can_modify': True, 'default_company_id': company_id}">
                                                                    <tree string="Budget Details" decoration-muted="is_readonly == True" decoration-danger="error_text != False">
                                                                        <field name="sequence" invisible="1"/>
                                                                        <field name="budget_line_type_id" options="{'no_create': True, 'no_open': True}"/>
                                                                        <field name="name" attrs="{'readonly': [('budget_line_type_id', '!=', False)]}"/>
                                                                        <field name="all_tag_ids" readonly="1" widget="many2many_tags"/>
                                                                        <field name="amount_fixed" sum="Amount planned" string="Forecast" widget="monetary"/>
                                                                        <field name="amount_engaged" sum="Amount engaged"  widget="monetary"/>
                                                                        <field name="amount_invoiced" sum="Amount engaged"  widget="monetary"/>
                                                                        <field name="profit_loss_amount_fixed" sum="Amount planned" string="P&amp;L Forecast" widget="monetary"/>
                                                                        <field name="profit_loss_amount_invoiced" sum="Amount engaged"  widget="monetary"/>
                                                                        <field name="text_distribution"/>
                                                                        <button string="Create purchase" icon="fa-cart-plus" type="object"
                                                                            name="create_purchase"/>
                                                                        <button string="Create supplier invoice" icon="fa-money" type="object"
                                                                            name="create_invoice"/>
                                                                        <field name="is_readonly" invisible="1" />
                                                                        <field name="type_id" invisible="1" />
                                                                        <field name="state" invisible="1" />
                                                                        <field name="has_manual_periods" invisible="1" />
                                                                        <field name="date_planned" invisible="1" />
                                                                        <field name="user_can_modify" invisible="1" />
                                                                        <field name="currency_id" invisible="1" />
                                                                        <field name="subtype" invisible="1" />
                                                                        <field name="error_text" invisible="1" />
                                                                    </tree>
                                                                    <form>
                                                                        <group colspan="4" col="4">
                                                                            <group colspan="2">
                                                                                <separator string="Budget detail information" colspan="2"/>
                                                                                <field name="budget_line_type_id" options="{'no_create': True, 'no_open': True}" widget="selction"/>
                                                                                <field name="name"/>
                                                                                <field name="subtype_id" attrs="{'readonly': [('is_readonly', '=', True)]}" widget="selection"/>
                                                                                <field name="user_can_modify" invisible="1" />
                                                                                <field name="type_id" invisible="1" />
                                                                                <field name="is_readonly" invisible="1" />
                                                                                <field name="has_details" invisible="1" />
                                                                                <field name="has_manual_periods" invisible="1" />
                                                                                <field name="state" invisible="1" />
                                                                                <field name="subtype" invisible="1" />
                                                                                <field name="currency_id" invisible="1" />
                                                                            </group>
                                                                            <group colspan="2">
                                                                                <separator string="Tags and Axes" colspan="2"/>
                                                                                <label for="all_tag_ids"/>
                                                                                <div>
                                                                                    <field name="all_tag_ids" readonly="1" widget="many2many_tags" nolabel="1" class="oe_inline"/>
                                                                                    <button string="Set axes" icon="fa-map-o" type="action" name="%(action_wizard_change_account_tags)d"
                                                                                        attrs="{'invisible': [('user_can_modify','=', False)]}" class="oe_inline oe_link"/>
                                                                                </div>
                                                                            </group>
                                                                            <notebook colspan="4">
                                                                                <page string="Amounts" col="4">
                                                                                    <group col="2">
                                                                                        <group>
                                                                                            <label for="amount_fixed"/>
                                                                                            <div>
                                                                                                <field name="amount_fixed" class="oe_inline" help="Total amount of your budget." widget="monetary"
                                                                                                    attrs="{'readonly': ['|', '|', ('state', 'not in', ['draft']), ('is_readonly', '=', True), ('has_details', '=', True)]}"/>
                                                                                                <button string="Transfer" icon="fa-briefcase" type="action" name="%(action_wizard_transfer_budget_amount)d"
                                                                                                    class="oe_link" attrs="{'invisible': ['|', ('linked_distribution_id', '!=', False), '|', ('state', 'in', ('cancel', 'done')), ('budget_detail_ids', '!=', [])]}" />
                                                                                            </div>
                                                                                            <label for="amount_engaged"/>
                                                                                            <div>
                                                                                                <field name="amount_engaged" widget="monetary" />
                                                                                                <button string="Purchase lines" icon="fa-arrow-right" type="action" name="%(action_wizard_view_budget_purchase_data)d"
                                                                                                    class="oe_link" attrs="{'invisible': [('linked_distribution_id', '!=', False)]}" />
                                                                                            </div>
                                                                                            <label for="amount_invoiced"/>
                                                                                            <div>
                                                                                                <field name="amount_invoiced" widget="monetary"/>
                                                                                                <button string="Journal entries" icon="fa-arrow-right" type="action" name="%(action_wizard_view_budget_journal_data)d"
                                                                                                    class="oe_link" attrs="{'invisible': [('linked_distribution_id', '!=', False)]}" />
                                                                                            </div>
                                                                                            <field name="amount_remaining" widget="monetary"/>
                                                                                        </group>
                                                                                        <group>
                                                                                            <field name="profit_loss_amount_fixed" string="P&amp;L Forecast" widget="monetary"/>
                                                                                            <label for="profit_loss_amount_engaged"/>
                                                                                            <div>
                                                                                                <field name="profit_loss_amount_engaged" widget="monetary"/>
                                                                                               
                                                                                            </div>
                                                                                            <field name="profit_loss_amount_remaining" widget="monetary"/>
                                                                                        </group>
                                                                                        <field name="linked_distribution_id" invisible="1" />
                                                                                        <field name="budget_detail_ids" invisible="1" />
                                                                                    </group>
                                                                                </page>
                                                                                <page string="Monthly amounts">
                                                                                    <field name="period_detail_ids" nolabel="1" attrs="{'readonly': ['|', ('budget_detail_ids', '!=', []), ('is_readonly', '=', True)]}">
                                                                                        <tree string="Period details" editable="top" create="false" delete="false" default_order="period_id desc">
                                                                                            <field name="period_id"/>
                                                                                            <field name="amount_fixed" widget="monetary" sum="Amount fixed"/>
                                                                                            <field name="amount_engaged" widget="monetary" sum="Amount engaged"/>
                                                                                            <field name="amount_invoiced" widget="monetary" sum="Amount invoiced"/>
                                                                                            <field name="profit_loss_amount_fixed" widget="monetary" sum="P&amp;L amount fixed"/>
                                                                                            <field name="profit_loss_amount_engaged" widget="monetary" sum="P&amp;L amount engaged"/>
                                                                                            <field name="profit_loss_amount_invoiced" widget="monetary" sum="P&amp;L amount invoiced"/>
                                                                                            <field name="currency_id" invisible="1" />
                                                                                        </tree>
                                                                                    </field>
                                                                                    <div attrs="{'invisible': [('error_text','=', False)]}" style="background-color: #FF4040; color: #800000; text-align: center;">
                                                                                        <strong><field name="error_text"/></strong>
                                                                                    </div>
                                                                                </page>
                                                                                
                                                                                <page string="Cost distribution" name="line_costs">
                                                                                    <div>
                                                                                        Use this tab to define to which departments and/or partners your costs are to be affected (unless specified per line / detail).
                                                                                    </div>
                                                                                    <button string="Specific distribution" icon="fa-tasks" type="action"
                                                                                        name="%(advanced_budget.action_wizard_add_budget_distribution)d"
                                                                                        attrs="{'invisible': [('state','in', ('draft', 'cancel', 'done'))]}"/>
                                                                                    <field name="distribution_cost_ids">
                                                                                        <tree editable="bottom">
                                                                                            <field name="child_id" domain="[('type', '=', 'partner')]"
                                                                                                options="{'no_create': True}" string="Partner" required="1" />
                                                                                            <field name="amount_fixed" widget="monetary"/>
                                                                                            <field name="percentage" sum="percentage"/>
                                                                                            <field name="amount_calculated" sum="Amount planned" widget="monetary"/>
                                                                                            <field name="currency_id" invisible="1" />
                                                                                        </tree>
                                                                                    </field>
                                                                                </page>
                                                                                <page string="Budget distribution" name="budgets">
                                                                                    <div>
                                                                                        Use this tab to define to which budgets your costs are to be affected (if any). IF YOU ADD A BUDGETARY DISTRIBUTION HERE, DO NOT ADD ANY TO THIS DETAIL'S LINE OR THE LINE'S PARENT BUDGET.
                                                                                    </div>
                                                                                    <field name="distribution_budget_ids" attrs="{'readonly': [('state', 'not in', ['draft'])]}">
                                                                                        <tree editable="bottom">
                                                                                            <field name="child_id" domain="[('type', 'in', ('periodic', 'project'))]"
                                                                                                options="{'no_create': True}" string="Budget" required="1" />
                                                                                            <field name="amount_fixed" widget="monetary"/>
                                                                                            <field name="percentage" sum="percentage"/>
                                                                                            <field name="amount_calculated" sum="Amount planned" widget="monetary"/>
                                                                                            <field name="currency_id" invisible="1" />
                                                                                        </tree>
                                                                                    </field>
                                                                                </page>
                                                                            </notebook>
                                                                        </group>
                                                                    </form>
                                                                </field>
                                                            </group>
                                                        </page>
                                                       
                                                        <page string="Cost distribution" name="line_costs">
                                                            <div>
                                                                Use this tab to define to which departments and/or partners your costs are to be affected (unless specified per line / detail).
                                                            </div>
                                                            <button string="Specific distribution" icon="fa-tasks" type="action"
                                                                name="%(advanced_budget.action_wizard_add_budget_distribution)d"
                                                                attrs="{'invisible': [('state','in', ('draft', 'cancel', 'done'))]}"/>
                                                            <field name="distribution_cost_ids">
                                                                <tree editable="bottom">
                                                                    <field name="child_id" domain="[('type', '=', 'partner')]"
                                                                        options="{'no_create': True}" string="Partner" required="1" />
                                                                    <field name="amount_fixed" widget="monetary"/>
                                                                    <field name="percentage" sum="percentage"/>
                                                                    <field name="amount_calculated" sum="Amount planned" widget="monetary"/>
                                                                    <field name="currency_id" invisible="1" />
                                                                </tree>
                                                            </field>
                                                        </page>
                                                        <page string="Budget distribution" name="budgets">
                                                            <div>
                                                                Use this tab to define to which budgets your costs are to be affected (if any). IF YOU ADD A BUDGETARY DISTRIBUTION HERE, DO NOT ADD ANY TO THIS LINE'S PARENT BUDGET.
                                                            </div>
                                                            <field name="distribution_budget_ids" attrs="{'readonly': [('state', 'not in', ['draft'])]}">
                                                                <tree editable="bottom">
                                                                    <field name="child_id" domain="[('type', 'in', ('periodic', 'project'))]"
                                                                        options="{'no_create': True}" string="Budget" required="1" />
                                                                    <field name="amount_fixed" widget="monetary"/>
                                                                    <field name="percentage" sum="percentage"/>
                                                                    <field name="amount_calculated" sum="Amount planned" widget="monetary"/>
                                                                    <field name="currency_id" invisible="1" />
                                                                </tree>
                                                            </field>
                                                        </page>
                                                    </notebook>
                                                </group>
                                            </form>
                                        </field>
                                    </page>
                                    <page string="Budget details" attrs="{'invisible': [('type', '!=', 'budget_line')]}" name="details">
                                        <field name="budget_detail_ids" attrs="{'readonly': [('state', 'not in', ['draft'])]}"
                                            context="{'default_type_id': %(advanced_budget.budget_element_type_detail)d,}">
                                            <tree string="Budget Details" editable="bottom">
                                                <field name="product_id"/>
                                                <field name="name"/>
                                                <field name="amount_fixed" sum="Amount planned" widget="monetary"/>
                                                <field name="amount_engaged" sum="Amount engaged" widget="monetary" />
                                                <field name="amount_invoiced" sum="Amount engaged" widget="monetary" />
                                                <field name="text_distribution"/>
                                                <button string="Specific distribution" icon="fa-tasks" type="action"
                                                    name="%(advanced_budget.action_wizard_add_budget_distribution)d"/>
                                                <field name="type_id" invisible="1" />
                                                <field name="state" invisible="1" />
                                                <field name="currency_id" invisible="1" />
                                                <field name="is_readonly" invisible="1" />
                                            </tree>
                                        </field>
                                    </page>
                                    <page string="Cost distribution" attrs="{'invisible': [('type', 'not in', ('periodic', 'project', 'budget_line', 'budget_detail'))]}" name="costs">
                                        <div>
                                            Use this tab to define to which departments and/or partners your costs are to be affected (unless specified per line / detail).
                                        </div>
                                        <field name="distribution_cost_ids">
                                            <tree editable="bottom">
                                                <field name="child_id" domain="[('type', '=', 'partner')]"
                                                    options="{'no_create': True}" string="Partner" required="1" />
                                                <field name="amount_fixed" widget="monetary"/>
                                                <field name="percentage" sum="percentage"/>
                                                <field name="amount_calculated" sum="Amount planned" widget="monetary"/>
                                                <field name="currency_id" invisible="1" />
                                            </tree>
                                        </field>
                                    </page>
                                    <page string="Budget distribution" name="budgets">
                                        <div>
                                            Use this tab to define to which budgets your costs are to be affected (if any). IF YOU ADD A BUDGETARY DISTRIBUTION HERE, DO NOT ADD ANY TO THIS LINE'S PARENT BUDGET.
                                        </div>
                                        <field name="distribution_budget_ids" attrs="{'readonly': [('state', 'not in', ['draft'])]}">
                                            <tree editable="bottom">
                                                <field name="child_id" domain="[('type', 'in', ('periodic', 'project'))]"
                                                    options="{'no_create': True}" string="Budget" required="1" />
                                                <field name="amount_fixed" widget="monetary"/>
                                                <field name="percentage" sum="percentage"/>
                                                <field name="amount_calculated" sum="Amount planned" widget="monetary"/>
                                                <field name="currency_id" invisible="1" />
                                            </tree>
                                        </field>
                                    </page>
                                    <page string="Personnel" attrs="{'invisible': [('type', '!=', 'project')]}">
                                        <field name="personnel_ids" nolabel="1" attrs="{'readonly': [('state', 'not in', ['draft'])]}">
                                            <tree string="Personnel" editable="bottom">
                                                <field name="employee_id"/>
                                                <field name="days"/>
                                                <field name="unit_price" widget="monetary"/>
                                                <field name="price_subtotal" widget="monetary"/>
                                                <field name="budget_line_id" options="{'no_create': True}"
                                                    domain="[('linked_distribution_id','=', False), '|', ('budget_id', '=', parent.id), ('budget_id.budget_id', '=', parent.id)]"/>
                                                <field name="currency_id" invisible="1" />
                                            </tree>
                                        </field>
                                    </page>
                                </notebook>
                            </group>
                        </group>
                        <div class="oe_chatter">
                            <field name="message_follower_ids" widget="mail_followers"
                                attrs="{'invisible': [('user_can_modify', '=', False)]}"/>
                            <field name="message_ids" widget="mail_thread"
                                attrs="{'invisible': [('user_can_modify', '=', False)]}"/> 
                        </div> 
                    </form>
                </xpath> 
            </field>
        </record> 
        <record model="ir.ui.view" id="budget_element_microcred_editable_form">
            <field name="name">budget.element.form</field>
            <field name="model">budget.element</field>
          <!-- <field name="groups_id" eval="[(4, ref('microcred_profile.group_microcred_admin')), (4, ref('microcred_profile.group_microcred_cost_control'))]"/> --> 
            <field name="inherit_id" ref="budget_element_microcred_form"/>
            <field name="priority" eval="91"/>
            <field name="arch" type="xml">
                <xpath expr="//field[@name='budget_line_ids']" position="attributes">
                    <attribute name="attrs">{'readonly': [('state', 'in', ['cancel', 'done'])]}</attribute>
                </xpath>
                <xpath expr="//field[@name='user_id']" position="attributes">
                    <attribute name="attrs">{'readonly': [('state', 'in', ['cancel', 'done'])]}</attribute>
                </xpath>
                <xpath expr="//field[@name='budget_department_id']" position="attributes">
                    <attribute name="attrs">{'readonly': [('state', 'in', ['cancel', 'done'])]}</attribute>
                </xpath>
                <xpath expr="//field[@name='distribution_budget_ids']" position="attributes">
                    <attribute name="attrs">{'readonly': [('state', 'in', ['cancel', 'done'])]}</attribute>
                </xpath>
            </field>
        </record> 

        <record model="ir.actions.act_window.view" id="advanced_budget.act_open_budget_line_view_form">
            <field name="act_window_id" ref="advanced_budget.action_budget_line"/>
            <field name="sequence" eval="20"/>
           <field name="view_mode">form</field>
            <field name="view_id" ref="budget_element_microcred_line_form"/>
        </record> 

        <record id="budget_line_microcred_tree" model="ir.ui.view">
            <field name="name">budget.element.microcred.tree</field>
            <field name="model">budget.element</field>
            <field name="inherit_id" ref="advanced_budget.view_budget_line_tree"/>
            <field name="priority" eval="5"/>
            <field name="arch" type="xml">
                <xpath expr="//field[@name='user_id']" position="before">
                    <field name="budget_department_id"/>
                </xpath>
                <xpath expr="//field[@name='amount_invoiced']" position="after">
                    <field name="currency_id"/>
                </xpath>
                <xpath expr="//field[@name='budget_detail_ids']" position="attributes">
                    <attribute name="invisible">1</attribute>
                </xpath>
                <xpath expr="//field[@name='amount_invoiced']" position="after">
                    <field name="amount_remaining" sum="Total" widget="monetary" options="{'currency_field': 'currency_id'}"/>
                </xpath>
                <xpath expr="//field[@name='amount_calculated']" position="attributes">
                    <attribute name="sum">Total</attribute>
                    <attribute name="widget">monetary</attribute>
                    <attribute name="options">{'currency_field': 'currency_id'}</attribute>
                </xpath>
                <xpath expr="//field[@name='amount_engaged']" position="attributes">
                    <attribute name="sum">Total</attribute>
                    <attribute name="widget">monetary</attribute>
                    <attribute name="options">{'currency_field': 'currency_id'}</attribute>
                </xpath>
                <xpath expr="//field[@name='amount_invoiced']" position="attributes">
                    <attribute name="sum">Total</attribute>
                    <attribute name="widget">monetary</attribute>
                    <attribute name="options">{'currency_field': 'currency_id'}</attribute>
                </xpath>
            </field>
        </record>

        <record id="view_budget_line_microcred_search" model="ir.ui.view">
            <field name="name">budget.element.microcred.search</field>
            <field name="model">budget.element</field>
            <field name="type">search</field>
            <field name="inherit_id" ref="advanced_budget.view_budget_line_search"/>
            <field name="priority" eval="5"/>
            <field name="arch" type="xml">
                <xpath expr="//field[@name='user_id']" position="after">
                    <field name="all_tag_ids"/>
                </xpath>
            </field>
        </record>

        <record model="ir.actions.act_window.view" id="advanced_budget.act_open_budget_line_view_tree">
            <field name="act_window_id" ref="advanced_budget.action_budget_line"/>
            <field name="sequence" eval="10"/>
             <field name="view_mode">tree</field>
            <field name="view_id" ref="budget_line_microcred_tree"/>
        </record>

        <record id="advanced_budget.action_budget_line" model="ir.actions.act_window">
            <field name="name">Budget Lines</field>
            <field name="type">ir.actions.act_window</field>
            <field name="res_model">budget.element</field>
            <field name="view_mode">tree,form,pivot</field>
            <field name="view_mode">form</field>
            <field name="context">{'search_default_periodic': 1, 'search_default_project': 1}</field>
            <field name="domain">[('type', 'in', ('budget_line', 'budget_detail')), ('user_can_modify', '=', True)]</field>
            <field name="search_view_id" ref="view_budget_line_microcred_search"/>
            <field name="help" type="html">
                <p class="oe_view_nocontent_create">
                    This view lists budget lines.
                    </p><p>
                    Budget lines are created from budgets.
                </p>
            </field>
        </record>

        <menuitem id="advanced_budget.menu_budget_main"
            sequence="5"
            parent="account.menu_finance"
            name="Budgets"/>

      <!-- Menu budget advanced -->

    <menuitem id="menu_account_axis_adv"
            parent="advanced_budget.menu_budget_main_adv"
            action="action_account_axis"
            sequence="9"/>
    <menuitem id="menu_budget_line_type_adv"
            parent="advanced_budget.menu_budget_main_adv"
            action="action_budget_line_type"
            sequence="10"/>

</odoo>
